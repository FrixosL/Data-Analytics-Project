---
title: "Data Analytics Group Assignment"
author: "Group 16"
date: "`r Sys.Date()`"
output:
  html_document:
    theme: readable
    highlight: zenburn
    toc: yes
    toc_float: yes
    number_sections: true
    code_folding: hide
---

```{r huxtable-stuff, message=FALSE, warning=FALSE, include=FALSE}
options("huxtable.knit_print_df" = FALSE)
library(lubridate)
library(here)
library(moderndive)
library(tidyverse)
library(ggfortify)
library(infer)
library(mosaic)
library(huxtable)
library(kableExtra)
library(tidyquant)
library(readxl) #need to load readxl explicitly, as it is not a core tidyverse 
library(GGally)
library(broom)
library(scales)
library(kableExtra)
library(knitr)
library(leaflet)
library(plotly) # Animation of graphs and tables
library(DT)
```

# Abstract

*sample text*

# Explanatory Data Analysis

## Load Data

```{r load_data, message=FALSE, warning=FALSE}

# Used link rather than downloading data to allow for reproducability
raw_data <- read_csv("http://data.insideairbnb.com/spain/catalonia/barcelona/2019-07-10/data/listings.csv.gz") 

```


## Looking at raw data

```{r EDA, echo=TRUE, message=FALSE, warning=FALSE}

glimpse(raw_data)

skimr::skim(raw_data)

```

## Cleaning Data

```{r clean_data, message=FALSE, warning=FALSE}

clean_data <- raw_data %>%
  # Filter for leisure purporses only
  filter(minimum_nights <= 4) %>% 
  # select only useful variables
  select(host_is_superhost, host_listings_count, host_identity_verified, neighbourhood_group_cleansed, city, zipcode,
         property_type, room_type, accommodates, bathrooms, bedrooms, beds, square_feet, price, weekly_price, monthly_price, 
         security_deposit, cleaning_fee, guests_included, extra_people, minimum_nights, maximum_nights, number_of_reviews,
         review_scores_rating, instant_bookable, cancellation_policy, is_location_exact) %>% 
  # 1.1 Data Wrangling
  mutate_at(c("price", "weekly_price", "monthly_price", "cleaning_fee", "extra_people", "security_deposit"), parse_number) %>% 
  # 1.2 Missing values
  mutate(cleaning_fee = 
           case_when(is.na(cleaning_fee) ~ 0, 
                     TRUE ~ cleaning_fee),
         # Property type simplified column added
         prop_type_simplified = 
           case_when(property_type %in% c("Apartment","Serviced apartment","Loft","House") ~ property_type,
                     TRUE ~ "Other"),
         region_by_price =
           case_when(neighbourhood_group_cleansed %in% c("Eixample", "Gràcia", "Sant Martí", "Sarrià-Sant Gervasi") ~ "Center",
                     neighbourhood_group_cleansed %in% c("Sant Andreu", "Nou Barris", "Horta-Guinardó") ~ "North",
                     neighbourhood_group_cleansed %in% c("Sants-Montjuïc", "Ciutat Vella", "Les Corts") ~ "South"),
         # Calculate price for 4 nights for two people
         price_4_nights = 4*price + cleaning_fee + ifelse(guests_included < 2, (2 - guests_included) * extra_people, 0),
         log_price_4_nights = log(price_4_nights))

# Frequency analysis of property types

clean_data_sorted <- clean_data %>% 
  group_by(property_type) %>% 
  summarize("Count" = n()) %>% 
  arrange(desc(Count)) %>%
  head()

clean_data %>%
  count(property_type, prop_type_simplified) %>%
  arrange(desc(n))

```

## Exploring relationships

```{r}

glimpse(clean_data)

mosaic::favstats(price ~ square_feet, data = clean_data)

skimr::skim(clean_data)

```

**Answer at minimum**:

*1. How many variables/columns? How many rows/observations?* 

* There are `r ncol(raw_data)` variables and `r nrow(raw_data)` observations.

*2. Which variables are numbers?*

`r select_if(raw_data, is.numeric) %>% colnames()`

3. Which are categorical or factor variables (numeric or character variables with variables that have a fixed and known set of possible values?

?

4. What are the correlations between variables? 

5. Does each scatterplot support a linear relationship between variables?

6. Do any of the correlations appear to be conditional on the value of a categorical variable?

##  Visualisations

```{r visualizations, echo=TRUE, message=FALSE, warning=FALSE}

clean_data %>%
  #mutate(host_is_superhost = case_when(
    #host_is_superhost %in% TRUE ~ superhost, FALSE ~ non_superhost, NA)) %>%
  select(host_is_superhost, price, review_scores_rating) %>%
  na.omit() %>%
  ggpairs(aes(colour = host_is_superhost, alpha = 0.3)) +
  theme_bw() 


 raw_data %>% filter(minimum_nights < 50) %>%  ggplot(aes(x=minimum_nights)) + geom_density()

```


# Mapping

```{r MAP, echo=TRUE, message=FALSE, warning=FALSE}

leaflet(data = filter(raw_data, minimum_nights <= 4)) %>% 
  addProviderTiles("OpenStreetMap.Mapnik") %>% 
  addCircleMarkers(lng = ~longitude, 
                   lat = ~latitude, 
                   radius = 1, 
                   fillColor = "blue", 
                   fillOpacity = 0.4, 
                   popup = ~listing_url,
                   label = ~property_type)

```

# Regression Analysis

## Visual Inspection

```{r Visual Analysis}

clean_data %>% 
  ggplot(aes(x = price_4_nights)) +
  geom_density() 
  
clean_data %>% 
  ggplot(aes(x = log(price_4_nights))) +
  geom_density()

```

*Which variable should you use for the regression model? Why?*

## Model 1

```{r model1}

model1 <- lm(log_price_4_nights ~ prop_type_simplified + number_of_reviews + review_scores_rating, data = clean_data)

get_regression_table(model1)

get_regression_summaries(model1)

autoplot(model1)

```

* review_scores: the estimate for this variable is -0.004	, denoting a very slight negative correlation with our dependent variable "log(price)". Moreover, looking at both the t-statistic (-6.321) and the p-value (0.000), we can conclude that the estimate is statistically significant at a 95% level.

* prop_type_simplified: being a dummy variable the interpretation for this variables is different, choosing "Apartment" as our base value we are now studying the incremental effect, on avergage, that different types of property have on the dependent variable. Simply from looking at the p-values, we can infer that Other, 0.157, is not significant at a 95% level therefore not providing much explainatory power to our model. When looking at the other categories, their interpretation is different as they all show p-values of zero.

* number_of_reviews is insignificant so remove it

## Model 2

```{r model2}

model2 <- lm(log_price_4_nights ~ prop_type_simplified + review_scores_rating + room_type, data = clean_data)

get_regression_table(model2)

get_regression_summaries(model2)

autoplot(model2)

```

*We want to determine if room_type is a significant predictor of the cost for 4 nights, given everything else in the model.*

## Model 3

*Are the number of bathrooms, bedrooms, beds, or size of the house (accommodates) significant predictors of log_price_4_nights?*

* Only bedrooms is not significant

```{r model3}

model3 <- lm(log_price_4_nights ~ prop_type_simplified + review_scores_rating + room_type + bathrooms + bedrooms + beds + accommodates, data = clean_data)

get_regression_table(model3)

get_regression_summaries(model3)

autoplot(model3)

```


## Model 4

*Do superhosts (host_is_superhost) command a pricing premium, after controlling for other variables?*

```{r model4}

model4 <- lm(log_price_4_nights ~ prop_type_simplified + review_scores_rating + room_type + bathrooms + beds + accommodates + host_is_superhost, data = clean_data)

get_regression_table(model4)

get_regression_summaries(model4)

autoplot(model4)

```


## Model 5

Most owners advertise the exact location of their listing (is_location_exact == TRUE), while a non-trivial proportion don’t. After controlling for other variables, is a listing’s exact location a significant predictor of log_price_4_nights?

*is_location_exact is not significant so remove it*

```{r model5}

model5 <- lm(log_price_4_nights ~ prop_type_simplified + review_scores_rating + room_type + bathrooms + beds + accommodates + host_is_superhost + is_location_exact, data = clean_data)

get_regression_table(model5)

get_regression_summaries(model5)

autoplot(model5)

```


## Model 6

For all cities, there are 3 variables that relate to neighbourhoods: neighbourhood, neighbourhood_cleansed, and neighbourhood_group_cleansed. There are typically more than 20 neighbourhoods in each city, and it wouldn’t make sense to include them all in your model. Use your city knowledge, or ask someone with city knowledge, and see whether you can group neighbourhoods together so the majority of listings falls in fewer (5-6 max) geographical areas. You would thus need to create a new categorical variabale neighbourhood_simplified and determine whether location is a predictor of log_price_4_nights

```{r model6}

model6 <- lm(log_price_4_nights ~ prop_type_simplified + review_scores_rating + room_type + bathrooms + beds + accommodates + host_is_superhost + region_by_price, data = clean_data)

get_regression_table(model6)

get_regression_summaries(model6)

autoplot(model6)

```

## Model 7

What is the effect of cancellation_policy on log_price_4_nights, after we control for other variables?

```{r model7}

model7 <- lm(log_price_4_nights ~ prop_type_simplified + number_of_reviews + review_scores_rating + room_type + cancellation_policy, data = clean_data)

get_regression_table(model7)

get_regression_summaries(model7)

autoplot(model7)

```

## Final Model

# Conclusion

## Rationale

## Significance and diagnostics 